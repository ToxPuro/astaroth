#pragma once

typedef enum {
    STENCIL_VALUE,
    STENCIL_DERX,
    STENCIL_DERY,
    STENCIL_DERZ,
    STENCIL_DERXX,
    STENCIL_DERYY,
    STENCIL_DERZZ,
    STENCIL_DERXY,
    STENCIL_DERXZ,
    STENCIL_DERYZ,
    NUM_STENCILS,
} Stencils;

#define STENCIL_WIDTH (STENCIL_ORDER + 1)
#define STENCIL_HEIGHT (STENCIL_WIDTH)
#define STENCIL_DEPTH (STENCIL_WIDTH)

#define STENCIL_MIDX (STENCIL_WIDTH / 2 + 1)
#define STENCIL_MIDY (STENCIL_HEIGHT / 2 + 1)
#define STENCIL_MIDZ (STENCIL_DEPTH / 2 + 1)

#define INV_DS (1.0l / 0.04908738521l)

#define DER1_3 (AcReal(INV_DS * 1.0l / 60.0l))
#define DER1_2 (AcReal(INV_DS * -3.0l / 20.0l))
#define DER1_1 (AcReal(INV_DS * 3.0l / 4.0l))
#define DER1_0 (0)

#define DER2_3 (AcReal(INV_DS * INV_DS * 1.0l / 90.0l))
#define DER2_2 (AcReal(INV_DS * INV_DS * -3.0l / 20.0l))
#define DER2_1 (AcReal(INV_DS * INV_DS * 3.0l / 2.0l))
#define DER2_0 (AcReal(INV_DS * INV_DS * -49.0l / 18.0l))

#define DERX_3 (AcReal(INV_DS * INV_DS * 2.0l / 720.0l))
#define DERX_2 (AcReal(INV_DS * INV_DS * -27.0l / 720.0l))
#define DERX_1 (AcReal(INV_DS * INV_DS * 270.0l / 720.0l))
#define DERX_0 (0)

// Or simpler, just set nonzeros
static __device__ const AcReal
    stencils[NUM_STENCILS][STENCIL_DEPTH][STENCIL_HEIGHT][STENCIL_WIDTH] = {
        {
            // Value
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 1, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
        }, // derx
        {
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},                                       //
                {0, 0, 0, 0, 0, 0, 0},                                       //
                {0, 0, 0, 0, 0, 0, 0},                                       //
                {-DER1_3, -DER1_2, -DER1_1, DER1_0, DER1_1, DER1_2, DER1_3}, //
                {0, 0, 0, 0, 0, 0, 0},                                       //
                {0, 0, 0, 0, 0, 0, 0},                                       //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
        },
        {
            // dery
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, -DER1_3, 0, 0, 0}, //
                {0, 0, 0, -DER1_2, 0, 0, 0}, //
                {0, 0, 0, -DER1_1, 0, 0, 0}, //
                {0, 0, 0, DER1_0, 0, 0, 0},  //
                {0, 0, 0, DER1_1, 0, 0, 0},  //
                {0, 0, 0, DER1_2, 0, 0, 0},  //
                {0, 0, 0, DER1_3, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
        },
        {
            // derz
            {
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, -DER1_3, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, -DER1_2, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, -DER1_1, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER1_0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER1_1, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER1_2, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER1_3, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
        }, // derxx
        {
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},                                    //
                {0, 0, 0, 0, 0, 0, 0},                                    //
                {0, 0, 0, 0, 0, 0, 0},                                    //
                {DER2_3, DER2_2, DER2_1, DER2_0, DER2_1, DER2_2, DER2_3}, //
                {0, 0, 0, 0, 0, 0, 0},                                    //
                {0, 0, 0, 0, 0, 0, 0},                                    //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
        },
        {
            // deryy
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, DER2_3, 0, 0, 0}, //
                {0, 0, 0, DER2_2, 0, 0, 0}, //
                {0, 0, 0, DER2_1, 0, 0, 0}, //
                {0, 0, 0, DER2_0, 0, 0, 0}, //
                {0, 0, 0, DER2_1, 0, 0, 0}, //
                {0, 0, 0, DER2_2, 0, 0, 0}, //
                {0, 0, 0, DER2_3, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
        },
        {
            // derzz
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER2_3, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER2_2, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER2_1, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER2_0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER2_1, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER2_2, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DER2_3, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
        },
        // derxy
        {
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {DERX_3, 0, 0, 0, 0, 0, -DERX_3}, //
                {0, DERX_2, 0, 0, 0, -DERX_2, 0}, //
                {0, 0, DERX_1, 0, -DERX_1, 0, 0}, //
                {0, 0, 0, DERX_0, 0, 0, 0},       //
                {0, 0, -DERX_1, 0, DERX_1, 0, 0}, //
                {0, -DERX_2, 0, 0, 0, DERX_2, 0}, //
                {-DERX_3, 0, 0, 0, 0, 0, DERX_3},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
        },
        {
            // derxz
            {
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {DERX_3, 0, 0, 0, 0, 0, -DERX_3}, //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, DERX_2, 0, 0, 0, -DERX_2, 0}, //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, DERX_1, 0, -DERX_1, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DERX_0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, -DERX_1, 0, DERX_1, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, -DERX_2, 0, 0, 0, DERX_2, 0}, //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {-DERX_3, 0, 0, 0, 0, 0, DERX_3}, //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},            //
                {0, 0, 0, 0, 0, 0, 0},
            },
        },
        {
            // deryz
            {
                {0, 0, 0, DERX_3, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, -DERX_3, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, DERX_2, 0, 0, 0},  //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, -DERX_2, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, DERX_1, 0, 0, 0},  //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, -DERX_1, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, DERX_0, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},      //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, -DERX_1, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, DERX_1, 0, 0, 0},  //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, -DERX_2, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, DERX_2, 0, 0, 0},  //
                {0, 0, 0, 0, 0, 0, 0},
            },
            {
                {0, 0, 0, -DERX_3, 0, 0, 0}, //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, 0, 0, 0, 0},       //
                {0, 0, 0, DERX_3, 0, 0, 0},
            },
        },
};

static __global__ void
dummy_kernel(void)
{
    /*
    // TODO RE-ENABLE WIP
    DCONST((AcIntParam)0);
    DCONST((AcInt3Param)0);
    DCONST((AcRealParam)0);
    DCONST((AcReal3Param)0);
    */
    acComplex a = exp(AcReal(1) * acComplex(1, 1) * AcReal(1));
    a* a;
}

AcResult
acKernelDummy(void)
{
    dummy_kernel<<<1, 1>>>();
    ERRCHK_CUDA_KERNEL_ALWAYS();
    return AC_SUCCESS;
}

template <int step_number>
static __global__ void
solve(const int3 start, const int3 end, VertexBufferArray vba)
{
    const int3 vertexIdx = (int3){
        threadIdx.x + blockIdx.x * blockDim.x + start.x,
        threadIdx.y + blockIdx.y * blockDim.y + start.y,
        threadIdx.z + blockIdx.z * blockDim.z + start.z,
    };
    const int3 globalVertexIdx = (int3){
        d_multigpu_offset.x + vertexIdx.x,
        d_multigpu_offset.y + vertexIdx.y,
        d_multigpu_offset.z + vertexIdx.z,
    };

    if (vertexIdx.x >= end.x || vertexIdx.y >= end.y || vertexIdx.z >= end.z)
        return;

    assert(vertexIdx.x < DCONST(AC_nx_max) && vertexIdx.y < DCONST(AC_ny_max) &&
           vertexIdx.z < DCONST(AC_nz_max));

    assert(vertexIdx.x >= DCONST(AC_nx_min) && vertexIdx.y >= DCONST(AC_ny_min) &&
           vertexIdx.z >= DCONST(AC_nz_min));

    const int NUM_FIELDS = NUM_VTXBUF_HANDLES;

    AcReal processed_stencils[NUM_FIELDS][NUM_STENCILS] = {0};
    for (int field = 0; field < NUM_FIELDS; ++field) {
        for (int depth = 0; depth < STENCIL_DEPTH; ++depth) {
            for (int height = 0; height < STENCIL_HEIGHT; ++height) {
                for (int width = 0; width < STENCIL_WIDTH; ++width) {
                    for (int stencil = 0; stencil < NUM_STENCILS; ++stencil) {
                        // if (stencils[stencil][depth][height][width] != 0) {
                        const int i        = vertexIdx.x - STENCIL_ORDER / 2 + width;
                        const int j        = vertexIdx.y - STENCIL_ORDER / 2 + height;
                        const int k        = vertexIdx.z - STENCIL_ORDER / 2 + depth;
                        const int idx      = IDX(i, j, k);
                        const double value = vba.in[field][idx];
                        processed_stencils[field][stencil] += stencils[stencil][depth][height]
                                                                      [width] *
                                                              value;
                        //}
                    }
                }
            }
        }

        const int idx = IDX(vertexIdx.x, vertexIdx.y, vertexIdx.z);
        // vba.out[field][idx] = processed_stencils[field][STENCIL_VALUE];
        // vba.out[field][idx] = processed_stencils[field][STENCIL_DERX];
        // vba.out[field][idx] = processed_stencils[field][STENCIL_DERXX];
        vba.out[field][idx] = processed_stencils[field][STENCIL_DERYZ];
    }
}

AcResult
acKernelIntegrateSubstep(const cudaStream_t stream, const int step_number, const int3 start,
                         const int3 end, VertexBufferArray vba)
{
    // optimal integration dims in a hash table (hashes start & end indices) + timeout
    // Mesh dimensions available with DCONST(AC_nx) etc.

    // For field f
    //  For stencil depth k
    //      For stencil height j
    //          For stencil width i
    //              For stencils w
    //                  processed_stencils[w] = stencils[w][k][j][i] *
    //            field[f][vertexIdx.z - MIDZ + k][vertexIdx.y - MIDY + j][vertexIdx.x - MIDX + i];
    //
    // Even better, template magic unroll and skip if stencils[w][k][j][i] == 0
    //
    // Test also space filling! if time
    //
    // ALSO NEW MENTALITY! We do not have preprocessed any more! We have actual
    // physical stencils! User sets stencils and does stencil fetches!
    //
    // Stencil value = {
    //      [-1][0] = 60.0 / 30.0,
    //      [0][0] = 1.0,
    // };
    // Field a attach value, derx; // VALUE IS ALWAYS IMPLICITLY ATTACHED
    //
    // value(a) * something
    // derx(a) * something
    //
    // ALSO CONSISTENCY! a is either a value or handle, not both
    //
    // OTA TEMPLATE STEP NUMBER MYOS POIS! RK3 from DSL stdlib!

    ERRCHK_ALWAYS(step_number >= 0);
    ERRCHK_ALWAYS(step_number < 3);
    const dim3 tpb    = (dim3){32, 4, 1};
    const size_t smem = 0; //(tpb.x + STENCIL_ORDER) * (tpb.y + STENCIL_ORDER) * sizeof(AcReal);

    const int3 n = end - start;
    const dim3 bpg((unsigned int)ceil(n.x / AcReal(tpb.x)), //
                   (unsigned int)ceil(n.y / AcReal(tpb.y)), //
                   (unsigned int)ceil(n.z / AcReal(tpb.z)));

    if (step_number == 0)
        solve<0><<<bpg, tpb, smem, stream>>>(start, end, vba);
    else if (step_number == 1)
        solve<1><<<bpg, tpb, smem, stream>>>(start, end, vba);
    else
        solve<2><<<bpg, tpb, smem, stream>>>(start, end, vba);

    ERRCHK_CUDA_KERNEL();

    return AC_SUCCESS;
}

AcResult
acKernelAutoOptimizeIntegration(const int3 start, const int3 end, VertexBufferArray vba)
{
    (void)start;
    (void)end;
    (void)vba;
    return AC_FAILURE;
}

/*
#if USE_SMEM
            extern __shared__ AcReal smem[];

            const int3 baseIdx = (int3){
                blockIdx.x * blockDim.x + start.x,
                blockIdx.y * blockDim.y + start.y,
                blockIdx.z * blockDim.z + start.z,
            };
            for (int height = 0; height < blockDim.y + STENCIL_ORDER; ++height) {
                const int smem_idx = threadIdx.x + threadIdx.y * blockDim.x +
                                     threadIdx.z * blockDim.x * blockDim.y;
                if (smem_idx < blockDim.x + STENCIL_ORDER) {
                    const int smem_out   = smem_idx + height * (blockDim.y + STENCIL_ORDER);
                    const int3 vtxbuf_in = baseIdx -
                                           (int3){STENCIL_ORDER / 2, STENCIL_ORDER / 2,
                                                  STENCIL_ORDER / 2} +
                                           (int3){smem_idx, height, depth};
                    smem[smem_out] = vba.in[field][IDX(vtxbuf_in)];
                }
            }

            __syncthreads();
#endif
*/